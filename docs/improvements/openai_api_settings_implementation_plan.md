# OpenAI API設定機能 実装計画書

## 1. 実装目的

Promptsmithアプリケーションにおいて、ユーザーが自身のOpenAI API Keyを安全に管理し、AIプロンプト実行に利用できるようにするための機能を実装する。この機能は、ユーザーエクスペリエンスの向上とセキュリティの確保を両立させることを目的とする。

## 2. 実装スケジュール

| フェーズ | 内容                         | 期間      | 担当               |
| :------- | :--------------------------- | :-------- | :----------------- |
| 1        | 基本設計の確認と環境準備     | 1日目     | フロントエンド担当 |
| 2        | Edge Function実装            | 2-3日目   | バックエンド担当   |
| 3        | Composableの実装             | 3-4日目   | フロントエンド担当 |
| 4        | コンポーネント実装           | 5-6日目   | フロントエンド担当 |
| 5        | ページ実装とルーティング設定 | 7日目     | フロントエンド担当 |
| 6        | 単体テスト・統合テスト       | 8-9日目   | テスト担当         |
| 7        | レビューと修正               | 10日目    | 全員               |
| 8        | デプロイ準備とリリース       | 11-12日目 | インフラ担当       |

## 3. 実装対象ファイル一覧

### 3.1 新規作成ファイル

```
composables/
  └── useOpenAiApi.ts         # OpenAI API操作用Composable

components/
  └── settings/
      ├── ApiKeyForm.vue      # API Key入力フォームコンポーネント
      └── ApiKeyInfo.vue      # API Key情報表示コンポーネント

pages/
  └── settings/
      └── api.vue             # API設定ページ

layouts/
  └── settings.vue            # 設定画面用レイアウト（オプション）

supabase/
  └── migrations/
      └── 003_create_user_settings.sql  # user_settingsテーブル作成

supabase/
  └── functions/
      ├── api-key-encrypt/    # API Key暗号化用Edge Function
      ├── api-key-decrypt/    # API Key復号用Edge Function
      └── api-key-delete/     # API Key削除用Edge Function

tests/
  ├── composables/
  │   └── useOpenAiApi.test.ts
  ├── components/
  │   └── settings/
  │       ├── ApiKeyForm.test.ts
  │       └── ApiKeyInfo.test.ts
  └── pages/
      └── settings/
          └── api.test.ts
```

### 3.2 修正対象ファイル

```
layouts/default.vue           # ナビゲーションメニューにAPI設定リンク追加
components/ui/TabNavigation.vue # ナビゲーションタブにAPI設定追加
```

## 4. 詳細実装計画

### 4.1 Supabase Migration実装

#### 実装タスク

- [ ] user_settingsテーブルの作成

  - 工数: 0.5日
  - テスト: マイグレーションの実行テスト、テーブル構造の確認
  - 実装方針: Supabaseマイグレーションファイルを作成し、必要なカラムとインデックスを定義
  - 完了条件: テーブルが正しく作成され、RLSポリシーが適切に設定されていること

- [ ] RLSポリシーの設定
  - 工数: 0.5日
  - テスト: 各ポリシーの動作確認（select, insert, update）
  - 実装方針: ユーザーIDに基づくRLSポリシーを実装し、データアクセスを制限
  - 完了条件: 異なるユーザー間でデータが適切に分離され、セキュリティが確保されていること

### 4.2 Edge Function実装

#### 4.2.1 api-key-encrypt

- [ ] api-key-encryptのEdge Function実装
  - 工数: 1日
  - テスト: 暗号化処理のユニットテスト、エラーハンドリングテスト
  - 実装方針:
    - AES-GCM暗号化アルゴリズムを使用
    - 環境変数からの暗号化キー取得
    - CORS対応の実装
    - Supabaseクライアントを使用したデータ保存
  - 完了条件:
    - API Keyが安全に暗号化されてDBに保存されること
    - 適切なエラーハンドリングが実装されていること
    - CORSリクエストが正しく処理されること

#### 4.2.2 api-key-decrypt

- [ ] api-key-decryptのEdge Function実装
  - 工数: 1日
  - テスト: 復号処理のユニットテスト、エラーハンドリングテスト
  - 実装方針:
    - AES-GCM復号アルゴリズムを使用
    - 環境変数からの暗号化キー取得
    - CORS対応の実装
    - Supabaseクライアントを使用したデータ取得
  - 完了条件:
    - 暗号化されたAPI Keyが正しく復号されること
    - キーが存在しない場合の適切な処理
    - 適切なエラーハンドリングが実装されていること

#### 4.2.3 api-key-delete

- [ ] api-key-deleteのEdge Function実装
  - 工数: 0.5日
  - テスト: 削除処理のユニットテスト、エラーハンドリングテスト
  - 実装方針:
    - Supabaseクライアントを使用したデータ更新
    - CORS対応の実装
    - ユーザー認証の確認
  - 完了条件:
    - API Keyが正しく削除（NULLに設定）されること
    - 適切なエラーハンドリングが実装されていること
    - 認証されたユーザーのみが操作可能であること

### 4.3 Composable実装（useOpenAiApi.ts）

- [x] useOpenAiApi Composableの基本構造実装

  - 工数: 0.5日
  - テスト: 状態管理のユニットテスト
  - 実装方針:
    - Composition APIを使用した状態管理
    - ref, computed, watchEffectの適切な使用
  - 完了条件:
    - API Key、検証状態、ローディング状態、エラーメッセージの状態が適切に管理されること

- [x] API Key取得・保存・削除機能の実装

  - 工数: 1日
  - テスト: Edge Function呼び出しのモックテスト、エラーハンドリングテスト
  - 実装方針:
    - Supabase Functionsの呼び出し
    - エラーハンドリングの実装
    - 非同期処理の適切な管理
  - 完了条件:
    - getApiKey、saveApiKey、removeApiKey関数が正しく動作すること
    - エラー発生時に適切なエラーメッセージが設定されること

- [x] API Key検証機能の実装

  - 工数: 0.5日
  - テスト: OpenAI API呼び出しのモックテスト、成功/失敗ケースのテスト
  - 実装方針:
    - OpenAI APIのモデルリスト取得エンドポイントを使用した検証
    - タイムアウト処理の実装
  - 完了条件:
    - validateApiKey関数が正しく動作し、有効/無効なAPIキーを判別できること
    - ネットワークエラー時の適切な処理が実装されていること

- [x] OpenAI APIリクエスト送信機能の実装
  - 工数: 0.5日
  - テスト: リクエスト送信のモックテスト、レスポンス処理テスト
  - 実装方針:
    - fetch APIを使用したリクエスト送信
    - リクエストヘッダーの適切な設定
    - レスポンス処理の実装
  - 完了条件:
    - sendRequest関数が正しく動作し、OpenAI APIにリクエストを送信できること
    - レスポンスが適切に処理されること

### 4.4 コンポーネント実装

#### 4.4.1 ApiKeyForm.vue

- [ ] ApiKeyForm.vueの基本構造実装

  - 工数: 0.5日
  - テスト: コンポーネントのレンダリングテスト
  - 実装方針:
    - Composition APIを使用したコンポーネント設計
    - TailwindCSSによるスタイリング
    - FormInputコンポーネントの再利用
  - 完了条件:
    - コンポーネントが正しくレンダリングされること
    - 入力フィールドと操作ボタンが適切に配置されていること

- [ ] API Key入力と表示/非表示切り替え機能の実装

  - 工数: 0.5日
  - テスト: 入力動作テスト、表示/非表示切り替えテスト
  - 実装方針:
    - パスワードタイプの入力フィールド
    - 表示/非表示切り替えボタンの実装
    - 入力値のバリデーション
  - 完了条件:
    - API Keyが正しく入力でき、表示/非表示を切り替えられること
    - 入力値のバリデーションが機能すること

- [ ] API Key保存・削除機能の実装
  - 工数: 0.5日
  - テスト: 保存・削除機能のテスト、ローディング状態テスト
  - 実装方針:
    - useOpenAiApi Composableの利用
    - ローディング状態の表示
    - 成功/エラー時のフィードバック
  - 完了条件:
    - API Keyが正しく保存・削除できること
    - 処理中はローディング状態が表示されること
    - 成功/エラー時に適切なフィードバックが表示されること

#### 4.4.2 ApiKeyInfo.vue

- [ ] ApiKeyInfo.vueの実装
  - 工数: 0.5日
  - テスト: コンポーネントのレンダリングテスト
  - 実装方針:
    - 静的な情報表示コンポーネント
    - TailwindCSSによるスタイリング
    - 外部リンクの実装
  - 完了条件:
    - API Keyに関する情報が適切に表示されること
    - 外部リンクが正しく機能すること
    - セキュリティ警告が視覚的に強調されていること

### 4.5 ページ実装

- [ ] pages/settings/api.vueの実装
  - 工数: 1日
  - テスト: ページのレンダリングテスト、コンポーネント統合テスト
  - 実装方針:
    - ApiKeyFormとApiKeyInfoコンポーネントの統合
    - ページレイアウトの設計
    - SEO対応の実装
  - 完了条件:
    - ページが正しくレンダリングされ、各コンポーネントが適切に配置されていること
    - レスポンシブデザインが実装されていること
    - SEO対応が適切に行われていること

### 4.6 ナビゲーション修正

- [ ] TabNavigation.vueの修正
  - 工数: 0.5日
  - テスト: ナビゲーションのレンダリングテスト、アクティブ状態テスト
  - 実装方針:
    - 既存のナビゲーションコンポーネントに新しいタブを追加
    - アクティブ状態の判定ロジック実装
    - アイコンの追加
  - 完了条件:
    - 「API設定」タブが正しく表示されること
    - アクティブ状態が正しく判定されること
    - タブクリックで正しくナビゲートされること

## 5. テスト計画

### 5.1 単体テスト

- ✅ **useOpenAiApi.test.ts** (完了)

  - API Keyの保存・取得・削除機能のテスト
  - API Key検証機能のテスト
  - エラーハンドリングのテスト
  - Edge Function呼び出しのモックテスト
  - OpenAI APIリクエストのモックテスト

- **ApiKeyForm.test.ts**

  - コンポーネントのレンダリングテスト
  - 入力フィールドの動作テスト
  - 表示/非表示切り替え機能のテスト
  - 保存・削除ボタンの動作テスト
  - バリデーション機能のテスト
  - エラー表示のテスト

- **ApiKeyInfo.test.ts**

  - コンポーネントのレンダリングテスト
  - 外部リンクの存在確認

- **api.test.ts（ページテスト）**
  - ページのレンダリングテスト
  - コンポーネントの統合テスト
  - レスポンシブデザインのテスト

### 5.2 統合テスト

- API Key保存から取得までの一連のフローテスト
- エラー発生時のフィードバック表示テスト
- ナビゲーションからのページ遷移テスト

### 5.3 E2Eテスト

以下のシナリオをCypress または Playwright で実装：

1. **基本フロー**

   - API設定ページへのナビゲーション
   - API Keyの入力と保存
   - API Keyの検証（モック応答使用）
   - API Keyの削除

2. **エラーケース**
   - 無効なAPI Keyの入力時のエラー表示
   - ネットワークエラー時の処理

## 6. デプロイ計画

### 6.1 デプロイ前チェックリスト

- [ ] すべての単体テストが成功すること
- [ ] すべてのコンポーネントテストが成功すること
- [ ] E2Eテストが成功すること
- [ ] コードレビューが完了していること
- [ ] セキュリティレビューが完了していること（特にEdge Functionの暗号化処理）
- [ ] 環境変数（OPENAI_ENCRYPTION_SECRET）が設定されていること

### 6.2 デプロイ手順

1. Supabaseマイグレーションの実行（user_settingsテーブル作成）
2. Edge Functionのデプロイ
3. フロントエンドコードのデプロイ
4. 動作確認

### 6.3 ロールバック計画

問題が発生した場合は、以下の手順でロールバックを行う：

1. フロントエンドコードを前バージョンに戻す
2. Edge Functionを前バージョンに戻す
3. 必要に応じてデータベースのロールバック

## 7. リスク管理

| リスク               | 影響度 | 発生確率 | 対策                                                                    |
| :------------------- | :----- | :------- | :---------------------------------------------------------------------- |
| API Keyの漏洩        | 高     | 低       | ・Edge Functionでの暗号化<br>・マスキング表示<br>・セキュリティ警告表示 |
| 暗号化キーの漏洩     | 高     | 低       | ・環境変数での管理<br>・定期的なキーローテーション                      |
| OpenAI APIの仕様変更 | 中     | 中       | ・エラーハンドリングの強化<br>・定期的な動作確認                        |
| Edge Function障害    | 中     | 中       | ・エラー時のフォールバック処理<br>・監視体制の構築                      |
| ブラウザ互換性の問題 | 中     | 低       | ・主要ブラウザでのテスト<br>・フォールバック機能の実装                  |

## 8. 将来の拡張計画

### 8.1 短期的な拡張（次期リリース候補）

- API使用量の表示機能
- 複数のAPI Keyプロファイル管理
- セッション終了時のAPI Key自動削除オプション

### 8.2 中長期的な拡張

- 組織IDの設定サポート
- モデル別設定（温度、トークン数など）
- API使用量の制限設定
- コスト予測機能

## 9. 実装時の注意点

### 9.1 セキュリティ

- 暗号化キー（OPENAI_ENCRYPTION_SECRET）は十分な強度を持つランダムな値を使用
- デバッグログにAPI Keyが出力されないよう注意
- Edge Functionのアクセス制御を適切に設定

### 9.2 パフォーマンス

- API Key検証は必要最小限に抑える
- Edge Function呼び出しの最適化
- クライアント側でのキャッシュ戦略の検討

### 9.3 ユーザビリティ

- エラーメッセージは具体的で分かりやすく表示
- API Key入力フォームはパスワード表示/非表示の切り替え機能を提供
- 処理中は適切なローディング表示
- 成功/失敗時のフィードバックを明確に表示

### 9.4 保守性

- コードの分離（UI/ロジック）を徹底
- 適切なコメント・ドキュメント
- 将来の拡張を考慮した設計
- テストカバレッジの確保
